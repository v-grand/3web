version: '3.8'

# Live Mode
# firstly remove /static_collected from .dockerignore
# then follow the guide - https://docs.divio.com/en/latest/how-to/local-in-live-configuration/
services:
    web:
        build:
            context: '.'
            dockerfile: Dockerfile
        ports:
            - '8000:80'
        volumes:
            - '.:/app:rw'
            - './data:/data:rw'
        command: python manage.py runserver 0.0.0.0:80
        env_file: backend/.local-env
        depends_on:
            - db
        networks:
            - app-network
        healthcheck:
            test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:80')"]
            interval: 30s
            timeout: 10s
            retries: 3

    frontend:
        build:
            context: '.'
            dockerfile: frontend.Dockerfile
        ports:
            - '8090:8090'
        volumes:
            - './frontend:/app:rw'
            # We want to ignore an existing frontend/node_modules
            # this allows a host-system yarn install and a docker based yarn work
            # side by side
            # read more at https://stackoverflow.com/questions/29181032/add-a-volume-to-docker-but-exclude-a-sub-folder
            - '/app/node_modules/'  # remove node_modules from the volume content
        working_dir: /app
        command: yarn webpack-dev-server-in-docker
        networks:
            - app-network

    db:
        image: postgres:16-alpine
        ports:
            - '5432:5432'
        environment:
            POSTGRES_DB: 'db'
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - 'postgres_data:/var/lib/postgresql/data'
        networks:
            - app-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5

networks:
    app-network:
        driver: bridge

volumes:
    postgres_data:

